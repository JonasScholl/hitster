<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Hitster QR Scanner</title>
        <link rel="stylesheet" href="./dist/output.css">
        <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    </head>

    <body class="bg-gray-900 text-white min-h-screen">
        <!-- QR Scanner Page -->
        <div id="scanner-page" class="container mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <h1
                    class="text-4xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    Hitster QR Scanner
                </h1>
                <p class="text-gray-300 text-lg">Scan a QR code to play music</p>
            </div>

            <div class="scanner-container">
                <div id="qr-reader" class="bg-gray-800 rounded-xl shadow-2xl"></div>
                <div id="qr-reader-results" class="mt-4 text-center text-gray-300"></div>
            </div>

            <div class="text-center mt-8">
                <button id="start-scanner"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg">
                    Start Scanner
                </button>
                <button id="stop-scanner"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg ml-4 hidden">
                    Stop Scanner
                </button>
            </div>

            <!-- Camera Permission Help -->
            <div id="camera-help" class="hidden mt-8 max-w-lg mx-auto bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4 text-yellow-400">Camera Access Required</h3>
                <div class="text-sm text-gray-300 space-y-3">
                    <p>To scan QR codes, this app needs access to your camera. Here's how to enable it:</p>
                    <div class="bg-gray-700 rounded p-3">
                        <p class="font-semibold text-white mb-2">For Chrome/Edge:</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>Click the camera icon in the address bar</li>
                            <li>Select "Allow" for camera access</li>
                            <li>Refresh the page and try again</li>
                        </ul>
                    </div>
                    <div class="bg-gray-700 rounded p-3">
                        <p class="font-semibold text-white mb-2">For Safari:</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>Go to Safari → Settings → Websites → Camera</li>
                            <li>Set this website to "Allow"</li>
                            <li>Refresh the page and try again</li>
                        </ul>
                    </div>
                    <div class="bg-gray-700 rounded p-3">
                        <p class="font-semibold text-white mb-2">Alternative:</p>
                        <p class="text-xs">You can also manually enter an iTunes preview URL below:</p>
                        <div class="mt-2">
                            <input type="url" id="manual-url" placeholder="Paste iTunes preview URL here..."
                                class="w-full px-3 py-2 bg-gray-600 text-white rounded text-xs">
                            <button id="load-manual-url"
                                class="mt-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-xs">
                                Load Audio
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio Player Page -->
        <div id="player-page" class="hidden container mx-auto px-4 py-8">
            <div class="max-w-md mx-auto">
                <!-- Header with close button -->
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold">Now Playing</h2>
                    <button id="close-player"
                        class="bg-gray-700 hover:bg-gray-600 text-white w-10 h-10 rounded-full flex items-center justify-center transition duration-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Audio Player Card -->
                <div class="audio-controls rounded-2xl p-8 shadow-2xl">
                    <div class="text-center mb-8">
                        <div class="w-32 h-32 bg-gray-800 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-16 h-16 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.793l-4-3A1 1 0 014 13V7a1 1 0 01.383-.793l4-3zM14 7a1 1 0 011-1 4 4 0 110 8 1 1 0 01-1-1V7z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold mb-2">Audio Preview</h3>
                        <p class="text-gray-200 text-sm">iTunes Preview</p>
                    </div>

                    <!-- Audio Element -->
                    <audio id="audio-player" class="hidden" preload="metadata"></audio>

                    <!-- Controls -->
                    <div class="space-y-6">
                        <!-- Play/Pause Button -->
                        <div class="text-center">
                            <button id="play-pause-btn"
                                class="bg-white text-gray-900 w-16 h-16 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-100 transition duration-300">
                                <svg id="play-icon" class="w-8 h-8 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Progress Bar -->
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm text-gray-200">
                                <span id="current-time">0:00</span>
                                <span id="duration">0:00</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2 cursor-pointer" id="progress-container">
                                <div class="progress-bar h-2 rounded-full transition-all duration-300" id="progress-bar"
                                    style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Volume Control -->
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5 text-gray-200" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.793l-4-3A1 1 0 014 13V7a1 1 0 01.383-.793l4-3zM14 7a1 1 0 011-1 4 4 0 110 8 1 1 0 01-1-1V7z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <input type="range" id="volume-slider" min="0" max="100" value="50"
                                class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            class HitsterApp {
                constructor() {
                    this.html5QrCode = null;
                    this.audio = document.getElementById('audio-player');
                    this.isPlaying = false;
                    this.currentAudioUrl = null;

                    this.initializeElements();
                    this.bindEvents();
                }

                initializeElements() {
                    // Scanner elements
                    this.scannerPage = document.getElementById('scanner-page');
                    this.playerPage = document.getElementById('player-page');
                    this.startScannerBtn = document.getElementById('start-scanner');
                    this.stopScannerBtn = document.getElementById('stop-scanner');
                    this.qrResults = document.getElementById('qr-reader-results');
                    this.cameraHelp = document.getElementById('camera-help');
                    this.manualUrlInput = document.getElementById('manual-url');
                    this.loadManualUrlBtn = document.getElementById('load-manual-url');

                    // Player elements
                    this.playPauseBtn = document.getElementById('play-pause-btn');
                    this.playIcon = document.getElementById('play-icon');
                    this.pauseIcon = document.getElementById('pause-icon');
                    this.currentTimeEl = document.getElementById('current-time');
                    this.durationEl = document.getElementById('duration');
                    this.progressBar = document.getElementById('progress-bar');
                    this.progressContainer = document.getElementById('progress-container');
                    this.volumeSlider = document.getElementById('volume-slider');
                    this.closePlayerBtn = document.getElementById('close-player');
                }

                bindEvents() {
                    // Scanner events
                    this.startScannerBtn.addEventListener('click', () => this.startScanner());
                    this.stopScannerBtn.addEventListener('click', () => this.stopScanner());
                    this.loadManualUrlBtn.addEventListener('click', () => this.loadManualUrl());
                    this.manualUrlInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.loadManualUrl();
                    });

                    // Player events
                    this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                    this.closePlayerBtn.addEventListener('click', () => this.closePlayer());
                    this.progressContainer.addEventListener('click', (e) => this.seekAudio(e));
                    this.volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value));

                    // Audio events
                    this.audio.addEventListener('loadedmetadata', () => this.updateDuration());
                    this.audio.addEventListener('timeupdate', () => this.updateProgress());
                    this.audio.addEventListener('ended', () => this.audioEnded());
                    this.audio.addEventListener('canplay', () => this.audioReady());
                }

                async startScanner() {
                    try {
                        // Hide camera help if visible
                        this.cameraHelp.classList.add('hidden');

                        // Check if camera permission is available
                        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                            // First check permissions
                            try {
                                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                                stream.getTracks().forEach(track => track.stop()); // Stop the test stream
                            } catch (permissionErr) {
                                console.error('Camera permission denied:', permissionErr);
                                this.showCameraPermissionError(permissionErr);
                                return;
                            }
                        } else {
                            this.qrResults.innerHTML = '<p class="text-red-400">Camera not supported on this device/browser</p>';
                            return;
                        }

                        this.html5QrCode = new Html5Qrcode("qr-reader");

                        const config = {
                            fps: 10,
                            qrbox: { width: 250, height: 250 },
                            aspectRatio: 1.0
                        };

                        await this.html5QrCode.start(
                            { facingMode: "environment" },
                            config,
                            (decodedText, decodedResult) => {
                                this.onScanSuccess(decodedText);
                            },
                            (errorMessage) => {
                                // Handle scan error silently
                            }
                        );

                        this.startScannerBtn.classList.add('hidden');
                        this.stopScannerBtn.classList.remove('hidden');
                        this.qrResults.innerHTML = '<p class="text-green-400">Scanner active - point camera at QR code</p>';

                    } catch (err) {
                        console.error('Error starting scanner:', err);
                        this.showCameraPermissionError(err);
                    }
                }

                async stopScanner() {
                    if (this.html5QrCode) {
                        try {
                            await this.html5QrCode.stop();
                            this.html5QrCode = null;

                            this.startScannerBtn.classList.remove('hidden');
                            this.stopScannerBtn.classList.add('hidden');
                            this.qrResults.innerHTML = '<p class="text-gray-400">Scanner stopped</p>';
                        } catch (err) {
                            console.error('Error stopping scanner:', err);
                        }
                    }
                }

                onScanSuccess(decodedText) {
                    console.log('QR Code scanned:', decodedText);

                    // Check if it's an iTunes audio preview URL
                    if (decodedText.includes('itunes-assets/AudioPreview') ||
                        decodedText.includes('.aac.p.m4a') ||
                        decodedText.includes('audio-ssl.itunes.apple.com')) {

                        this.qrResults.innerHTML = '<p class="text-green-400">Audio URL detected! Loading player...</p>';
                        this.loadAudio(decodedText);
                    } else {
                        this.qrResults.innerHTML = `<p class="text-yellow-400">Scanned: ${decodedText}</p><p class="text-gray-400">This doesn't appear to be an iTunes audio preview URL.</p>`;
                    }
                }

                async loadAudio(url) {
                    try {
                        // Stop scanner first
                        await this.stopScanner();

                        // Set audio source
                        this.currentAudioUrl = url;
                        this.audio.src = url;
                        this.audio.volume = this.volumeSlider.value / 100;

                        // Show player page
                        this.showPlayerPage();

                    } catch (err) {
                        console.error('Error loading audio:', err);
                        this.qrResults.innerHTML = '<p class="text-red-400">Error loading audio file</p>';
                    }
                }

                showPlayerPage() {
                    this.scannerPage.classList.add('hidden');
                    this.playerPage.classList.remove('hidden');
                }

                closePlayer() {
                    // Stop audio
                    this.audio.pause();
                    this.audio.src = '';
                    this.isPlaying = false;
                    this.updatePlayPauseButton();

                    // Reset progress
                    this.progressBar.style.width = '0%';
                    this.currentTimeEl.textContent = '0:00';
                    this.durationEl.textContent = '0:00';

                    // Show scanner page
                    this.playerPage.classList.add('hidden');
                    this.scannerPage.classList.remove('hidden');

                    // Clear results and manual URL input
                    this.qrResults.innerHTML = '';
                    this.manualUrlInput.value = '';
                    this.cameraHelp.classList.add('hidden');
                }

                showCameraPermissionError(error) {
                    let errorMessage = 'Camera access denied. ';

                    if (error.name === 'NotAllowedError') {
                        errorMessage += 'Please allow camera access and refresh the page.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += 'No camera found on this device.';
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage += 'Camera not supported on this browser.';
                    } else {
                        errorMessage += 'Please check camera permissions.';
                    }

                    this.qrResults.innerHTML = `<p class="text-red-400">${errorMessage}</p>`;
                    this.cameraHelp.classList.remove('hidden');
                }

                loadManualUrl() {
                    const url = this.manualUrlInput.value.trim();

                    if (!url) {
                        this.qrResults.innerHTML = '<p class="text-yellow-400">Please enter a URL</p>';
                        return;
                    }

                    // Check if it's a valid iTunes audio preview URL
                    if (url.includes('itunes-assets/AudioPreview') ||
                        url.includes('.aac.p.m4a') ||
                        url.includes('audio-ssl.itunes.apple.com')) {

                        this.qrResults.innerHTML = '<p class="text-green-400">Loading audio from URL...</p>';
                        this.loadAudio(url);
                    } else {
                        this.qrResults.innerHTML = '<p class="text-yellow-400">This doesn\'t appear to be an iTunes audio preview URL. Trying anyway...</p>';
                        // Try to load it anyway
                        setTimeout(() => {
                            this.loadAudio(url);
                        }, 1000);
                    }
                }

                togglePlayPause() {
                    if (this.isPlaying) {
                        this.audio.pause();
                        this.isPlaying = false;
                    } else {
                        this.audio.play();
                        this.isPlaying = true;
                    }
                    this.updatePlayPauseButton();
                }

                updatePlayPauseButton() {
                    if (this.isPlaying) {
                        this.playIcon.classList.add('hidden');
                        this.pauseIcon.classList.remove('hidden');
                    } else {
                        this.playIcon.classList.remove('hidden');
                        this.pauseIcon.classList.add('hidden');
                    }
                }

                updateDuration() {
                    const duration = this.audio.duration;
                    this.durationEl.textContent = this.formatTime(duration);
                }

                updateProgress() {
                    const currentTime = this.audio.currentTime;
                    const duration = this.audio.duration;

                    if (duration > 0) {
                        const progress = (currentTime / duration) * 100;
                        this.progressBar.style.width = progress + '%';
                    }

                    this.currentTimeEl.textContent = this.formatTime(currentTime);
                }

                seekAudio(e) {
                    const rect = this.progressContainer.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const width = rect.width;
                    const percentage = clickX / width;
                    const newTime = percentage * this.audio.duration;

                    this.audio.currentTime = newTime;
                }

                setVolume(value) {
                    this.audio.volume = value / 100;
                }

                audioEnded() {
                    this.isPlaying = false;
                    this.updatePlayPauseButton();
                    this.progressBar.style.width = '0%';
                    this.audio.currentTime = 0;
                }

                audioReady() {
                    console.log('Audio ready to play');
                }

                formatTime(seconds) {
                    if (isNaN(seconds)) return '0:00';

                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = Math.floor(seconds % 60);
                    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                }
            }

            // Initialize app when DOM is loaded
            document.addEventListener('DOMContentLoaded', () => {
                new HitsterApp();
            });
        </script>
    </body>

</html>